# 登分助手 - 极简架构说明

## 设计理念

**极简、可靠、轻量化**

本次重构完全回归基础，删除所有复杂特性，只保留核心功能。

---

## 核心模块

### 1. speech_recognition.py (271行)
**功能**：语音识别
**架构**：单次录音识别
**流程**：
```
录音 → VAD检测 → 停止 → Whisper识别 → 回调
```

**关键特性**：
- ✅ 简单的VAD（能量检测）
- ✅ 静音1.5秒自动停止
- ✅ 最短录音0.8秒
- ✅ 音频预处理（去DC、归一化）
- ✅ 简单的prompt引导
- ✅ 基础后处理（中文数字转换）

**无**：
- ❌ 复杂的异步架构
- ❌ 持续录音系统
- ❌ 识别队列
- ❌ 重复检测
- ❌ 复杂的prompt工程

### 2. student_parser.py (94行)
**功能**：解析识别结果
**架构**：简单的正则匹配
**流程**：
```
文本 → 提取分数 → 提取序号/姓名 → 返回结果
```

**关键特性**：
- ✅ 必须有"XX分"格式
- ✅ 优先匹配序号（数字号）
- ✅ 其次匹配姓名（2-4个中文）
- ✅ 支持按逗号分割多个

**无**：
- ❌ 复杂的中文数字转换
- ❌ 繁体字处理
- ❌ 多种模糊匹配

### 3. excel_handler.py (510行)
**功能**：Excel文件操作
**特性**：
- ✅ 序号查找（直接计算行号）
- ✅ 姓名查找（拼音模糊匹配）
- ✅ 成绩更新
- ✅ 文件保存

### 4. gui.py
**功能**：图形界面
**特性**：
- ✅ 选择Excel文件
- ✅ 开始/停止录音
- ✅ 显示识别结果
- ✅ 语音播报确认

---

## 使用流程

### 基础流程
```
1. 打开程序
2. 选择Excel文件
3. 点击"开始录音"
4. 说"1号100分"
5. 等待1.5秒静音
6. 系统自动识别并保存
7. 播报确认信息
8. 自动继续下一次录音
```

### 识别格式

**推荐格式**：
- `1号100分` ✅
- `二号95分` ✅
- `张三90分` ✅

**不推荐**：
- `1号，100分`（可以识别，但不如连读）
- `第1号学生100分`（太复杂）

---

## 关键参数

### VAD参数
```python
silence_duration = 1.5  # 静音1.5秒停止
min_speech_duration = 0.8  # 最短0.8秒
threshold = 0.02  # 能量阈值
```

### Whisper参数
```python
beam_size = 5
temperature = 0.0
language = "zh"
initial_prompt = "一号，二号，三号，四号，五号，100分，95分，90分，85分"
```

---

## 代码行数统计

| 模块 | 行数 | 说明 |
|------|------|------|
| speech_recognition.py | 271 | 语音识别 |
| student_parser.py | 94 | 信息解析 |
| excel_handler.py | 510 | Excel操作 |
| gui.py | ~500 | 图形界面 |
| speech_synthesis.py | ~100 | 语音播报 |
| **总计** | **~1475** | **极简版** |

**对比**：
- 之前复杂版本：~2000+行
- 减少了 ~30%代码

---

## 已知限制

1. **不支持连续对话**：每次识别后需要重新开始
2. **必须说"分"**：如果只说"1号100"，无法识别
3. **序号优先**：如果既有序号又有姓名，优先使用序号
4. **最多100分**：分数超过100会被过滤

---

## 故障排查

### 问题1：识别不到
**检查**：
- 麦克风是否工作？
- 是否说完后等待了1.5秒？
- 是否说了"分"字？

### 问题2：识别错误
**检查**：
- prompt是否合适？
- VAD阈值是否太高/太低？
- 环境噪音是否太大？

### 问题3：Excel保存失败
**检查**：
- Excel文件是否被占用？
- 文件路径是否有写权限？

---

## 下一步优化（可选）

如果基础功能正常，可以考虑：
1. 增加模型大小（base → medium）
2. 优化prompt
3. 添加音频降噪
4. 改进VAD算法

**但不要**：
- 引入复杂的异步架构
- 添加不必要的功能
- 过度优化

---

**原则：简单、可靠、够用即可**
